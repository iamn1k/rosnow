<!--
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Krasnoyarsk Krai 3D Terrain with Model</title>
    <meta property="og:description" content="Go beyond hillshade and show elevation in actual 3D." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<script type="module">
    console.log("Here");
    const krasnoyarskBounds = [
        [90.0, 53.0], // Southwest coordinates [lng, lat]
        [96.0, 60.0]  // Northeast coordinates [lng, lat]
    ];

    const map = new maplibregl.Map({
        container: 'map',
        zoom: 6,
        center: [92.857, 56.015], // Center coordinates for Krasnoyarsk Krai
        pitch: 70,
        bearing: 0,
        antialias: true,
        style: {
            version: 8,
            sources: {
                osm: {
                    type: 'raster',
                    tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '&copy; OpenStreetMap Contributors',
                    maxzoom: 19
                },
                terrainSource: {
                    type: 'raster-dem',
                    tiles: [
                        'https://tiles.wifidb.net/data/jaxa_terrainrgb/{z}/{x}/{y}.png'
                    ],
                    tileSize: 256
                }
            },
            layers: [
                {
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }
            ],
            terrain: {
                source: 'terrainSource',
                exaggeration: 1.5
            },
            sky: {}
        },
        maxZoom: 18,
        maxPitch: 85,
        maxBounds: krasnoyarskBounds // Restrict map to Krasnoyarsk Krai
    });

    map.addControl(new maplibregl.NavigationControl({
        visualizePitch: true,
        showZoom: true,
        showCompass: true
    }));

    // // Создание маркера
    // const marker = new maplibregl.Marker()
    //     .setLngLat([92.857, 56.015]) // Координаты маркера
    //     .setPopup(new maplibregl.Popup().setText('Здесь должна быть модель самолета')) // Подсказка
    //     .addTo(map); // Добавление маркера на карту
    
    const tb = (window.tb = new Threebox(
        map,
        map.getCanvas().getContext('webgl'),
        {
            defaultLights: true
        }
    ));

    map.on('style.load', () => {


        map.addLayer({
            id: 'custom_layer',
            type: 'custom',
            renderingMode: '3d',
            onAdd: function (map, mbxContext) {
                var options = {
                    obj: 'http://localhost:9000/scene.glb',
                    type: 'gltf',
                    scale: 1,
                    units: 'meters',
                    rotation: { x: 90, y: 0, z: 0 }, //default rotation
                    anchor: 'center'
                }

                tb.loadObj(options, function (model) {
                    console.log("Here 2");
                    let plane = model.setCoords([92.857, 56.015]);
                    //plane.setAltitude(100); // Увеличьте значение, чтобы поднять модель выше
                    tb.add(plane);
                    console.log(plane);
                }, function (error) {
                    console.error('Error loading model:', error);
                });

            },

            render: function (gl, matrix) {
                tb.update();
            }
        });
    });
    /*
    map.on('error', (e) => {
        console.error('Map error:', e);
    });*/
</script>
</body>
</html>
-->



<!--
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Krasnoyarsk Krai 3D Terrain with Model</title>
    <meta property="og:description" content="Go beyond hillshade and show elevation in actual 3D." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/three@0.152.0/build/three.min.js"></script>
    <script src="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        #controls { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; z-index: 1; }
        .marker {
            background-color: red;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="controls">
    <h3>Введите координаты</h3>
    <input type="text" id="lat" placeholder="Широта">
    <input type="text" id="lng" placeholder="Долгота">
    <input type="text" id="alt" placeholder="Высота">
    <button id="addPoint">Добавить точку</button>
    <button id="drawPath">Построить путь</button>
</div>
<div id="map"></div>
<script type="module">
    const krasnoyarskBounds = [
        [90.0, 53.0], // Southwest coordinates [lng, lat]
        [96.0, 60.0]  // Northeast coordinates [lng, lat]
    ];

    const map = new maplibregl.Map({
        container: 'map',
        zoom: 6,
        center: [92.857, 56.015], // Center coordinates for Krasnoyarsk Krai
        pitch: 70,
        bearing: 0,
        antialias: true,
        style: {
            version: 8,
            sources: {
                osm: {
                    type: 'raster',
                    tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '&copy; OpenStreetMap Contributors',
                    maxzoom: 19
                },
                terrainSource: {
                    type: 'raster-dem',
                    tiles: [
                        'https://tiles.wifidb.net/data/jaxa_terrainrgb/{z}/{x}/{y}.png'
                    ],
                    tileSize: 256
                }
            },
            layers: [
                {
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }
            ],
            terrain: {
                source: 'terrainSource',
                exaggeration: 1.5
            },
            sky: {}
        },
        maxZoom: 18,
        maxPitch: 85,
        maxBounds: krasnoyarskBounds // Restrict map to Krasnoyarsk Krai
    });

    const tb = new Threebox(
        map,
        map.getCanvas().getContext('webgl'),
        {
            defaultLights: true
        }
    );

    const points = [];

    map.on('style.load', () => {
        map.addLayer({
            id: 'custom_layer',
            type: 'custom',
            renderingMode: '3d',
            onAdd(map, mbxContext) {
                tb.update();
            },
            render(gl, matrix) {
                tb.update();
            }
        });
    });

    document.getElementById('addPoint').addEventListener('click', () => {
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(document.getElementById('lng').value);
        const alt = parseFloat(document.getElementById('alt').value);

        if (!isNaN(lat) && !isNaN(lng) && !isNaN(alt)) {
            points.push({ lat, lng, alt });
            alert(`Точка добавлена: [${lat}, ${lng}, ${alt}]`);

        const marker = new maplibregl.Marker()
        .setLngLat([lng, lat]) // Координаты маркера
        .setPopup(new maplibregl.Popup().setText('Здесь должна быть модель самолета')) // Подсказка
        .addTo(map); // Добавление маркера на карту

        } else {
            alert("Пожалуйста, введите валидные координаты.");
        }
    });

    function createLine(start, end) {
    const positions = new Float32Array(6); // 2 vertices * 3 coordinates (x, y, z)

    // Project the geographical coordinates to world coordinates
    const startWorld = tb.projectToWorld(start);
    const endWorld = tb.projectToWorld(end);

    // Set the positions for the line
    positions[0] = startWorld.x; // x of start
    positions[1] = startWorld.y; // y of start
    positions[2] = startWorld.z; // z of start
    positions[3] = endWorld.x;   // x of end
    positions[4] = endWorld.y;   // y of end
    positions[5] = endWorld.z;   // z of end

    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

    return new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0xff0000 }));
}

    document.getElementById('drawPath').addEventListener('click', () => {
        if (points.length < 2) {
            alert("Добавьте хотя бы две точки для построения пути.");
            return;
        }

        // Create lines between each pair of points
        for (let i = 0; i < points.length - 1; i++) {
            const startPoint = points[i];
            const endPoint = points[i + 1];

            // Create a line using the createLine function
            const lineMesh = createLine(
                [startPoint.lng, startPoint.lat], // Start point as [lng, lat]
                [endPoint.lng, endPoint.lat]      // End point as [lng, lat]
            );

            // Add the line mesh to Threebox world
            tb.world.add(lineMesh);
        }

        tb.update(); // Force the map to render

        alert("Путь построен!");
    });
</script>
</body>
</html>

-->
<!--
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Krasnoyarsk Krai 3D Terrain with Model</title>
    <meta property="og:description" content="Go beyond hillshade and show elevation in actual 3D." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/three@0.152.0/build/three.min.js"></script>
    <script src="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        #controls { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; z-index: 1; }
        .marker {
            background-color: red;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="controls">
    <h3>Введите координаты</h3>
    <input type="text" id="lat" placeholder="Широта">
    <input type="text" id="lng" placeholder="Долгота">
    <input type="text" id="alt" placeholder="Высота">
    <button id="addPoint">Добавить точку</button>
    <button id="drawPath">Построить путь</button>
    <button id="startFlight" style="display:none;">Начать полет</button>
</div>
<div id="map"></div>
<script type="module">
    const krasnoyarskBounds = [
        [90.0, 53.0], // Southwest coordinates [lng, lat]
        [96.0, 60.0]  // Northeast coordinates [lng, lat]
    ];

    const map = new maplibregl.Map({
        container: 'map',
        zoom: 6,
        center: [92.857, 56.015], // Center coordinates for Krasnoyarsk Krai
        pitch: 70,
        bearing: 0,
        antialias: true,
        style: {
            version: 8,
            sources: {
                osm: {
                    type: 'raster',
                    tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '&copy; OpenStreetMap Contributors',
                    maxzoom: 19
                },
                terrainSource: {
                    type: 'raster-dem',
                    tiles: [
                        'https://tiles.wifidb.net/data/jaxa_terrainrgb/{z}/{x}/{y}.png'
                    ],
                    tileSize: 256
                }
            },
            layers: [
                {
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }
            ],
            terrain: {
                source: 'terrainSource',
                exaggeration: 1.5
            },
            sky: {}
        },
        maxZoom: 18,
        maxPitch: 85,
        maxBounds: krasnoyarskBounds // Restrict map to Krasnoyarsk Krai
    });

    const tb = new Threebox(
        map,
        map.getCanvas().getContext('webgl'),
        {
            defaultLights: true
        }
    );
    window.tb = tb;
    const points = [];  // Массив для хранения точек маршрута
    let planeModel = null;
    let currentPointIndex = 0;  // Индекс текущей точки маршрута
    let totalDistance = 0;  // Общая дистанция маршрута

    map.on('style.load', () => {
        map.addLayer({
            id: 'custom_layer',
            type: 'custom',
            renderingMode: '3d',
            onAdd(map, mbxContext) {
                tb.update();
            },
            render(gl, matrix) {
                tb.update();
            }
        });
    });

    document.getElementById('addPoint').addEventListener('click', () => {
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(document.getElementById('lng').value);
        const alt = parseFloat(document.getElementById('alt').value);

        if (!isNaN(lat) && !isNaN(lng) && !isNaN(alt)) {
            points.push({ lat, lng, alt });
            alert(`Точка добавлена: [${lat}, ${lng}, ${alt}]`);

            const marker = new maplibregl.Marker()
                .setLngLat([lng, lat])
                .setPopup(new maplibregl.Popup().setText('Точка маршрута'))
                .addTo(map);
        } else {
            alert("Пожалуйста, введите валидные координаты.");
        }
    });



    // Создание пути между точками
    function createLine(start, end) {
        const positions = new Float32Array(6); // 2 vertices * 3 coordinates (x, y, z)

        // Project the geographical coordinates to world coordinates
        const startWorld = tb.projectToWorld(start);
        const endWorld = tb.projectToWorld(end);

        // Set the positions for the line
        positions[0] = startWorld.x; // x of start
        positions[1] = startWorld.y; // y of start
        positions[2] = startWorld.z; // z of start
        positions[3] = endWorld.x;   // x of end
        positions[4] = endWorld.y;   // y of end
        positions[5] = endWorld.z;   // z of end

        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        return new THREE.Line(geometry, new THREE.LineBasicMaterial({ color: 0xff0000 }));
    }

    // Построение пути
    document.getElementById('drawPath').addEventListener('click', () => {
        if (points.length < 2) {
            alert("Добавьте хотя бы две точки для построения пути.");
            return;
        }

        // Create lines between each pair of points
        for (let i = 0; i < points.length - 1; i++) {
            const startPoint = points[i];
            const endPoint = points[i + 1];

            // Create a line using the createLine function
            const lineMesh = createLine(
                [startPoint.lng, startPoint.lat], // Start point as [lng, lat]
                [endPoint.lng, endPoint.lat]      // End point as [lng, lat]
            );

            // Add the line mesh to Threebox world
            tb.world.add(lineMesh);

            // Calculate total distance of the path
            totalDistance += calculateDistance(startPoint.lat, startPoint.lng, endPoint.lat, endPoint.lng);
        }

        tb.update(); // Force the map to render

        alert("Путь построен!");
        document.getElementById('startFlight').style.display = 'inline-block';
    });

    // Начало полета
    document.getElementById('startFlight').addEventListener('click', () => {
        if (points.length < 2) {
            alert("Добавьте точки маршрута.");
            return;
        }

        // Загрузка модели самолета
        const options = {
            obj: 'http://localhost:9000/scene.glb', // Укажите путь к модели GLB
            type: 'gltf',
            scale: 0.3,
            units: 'meters',
            rotation: { x: 90, y: 0, z: 0 },
            anchor: 'center'
        };

        window.tb.loadObj(options, function (model) {
            planeModel = model;
            planeModel.setCoords([points[0].lng, points[0].lat, points[0].alt]);
            window.tb.add(planeModel);
            window.tb.update();

            // Расчет общей дистанции маршрута
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                totalDistance += calculateDistance(
                    points[i].lat, points[i].lng,
                    points[i + 1].lat, points[i + 1].lng
                );
            }

            // Переводим скорость из км/ч в м/с (1 км/ч = 1/3.6 м/с)
            const flightSpeed = 50 / 3.6;  // скорость в м/с

            // Начинаем анимацию
            let currentTime = 0;  // Текущее время анимации (в миллисекундах)
            const duration = totalDistance / flightSpeed * 1000; // Общая длительность полета в миллисекундах
            const path = points.map(p => [p.lng, p.lat, p.alt]);

            function animate() {
                currentTime += 1000 / 60; // Обновление каждую миллисекунду
                const t = currentTime / duration; // Прогресс (от 0 до 1)

                if (t < 1) {
                    // Находим две точки для интерполяции
                    const startIndex = Math.floor(t * (points.length - 1));
                    const endIndex = startIndex + 1;
                    const p1 = points[startIndex];
                    const p2 = points[endIndex];

                    // Интерполяция между точками маршрута
                    const interpolate = (p1, p2, t) => {
                        return {
                            lat: p1.lat + (p2.lat - p1.lat) * t,
                            lng: p1.lng + (p2.lng - p1.lng) * t,
                            alt: p1.alt + (p2.alt - p1.alt) * t,
                        };
                    };

                    const pos = interpolate(p1, p2, (t * (points.length - 1)) % 1);
                    planeModel.setCoords([pos.lng, pos.lat, pos.alt]);

                    window.tb.update();
                    requestAnimationFrame(animate); // Продолжаем анимацию
                } else {
                    alert("Полет завершен!");
                }
            }

            animate(); // Запуск анимации
        });
    });

    // Функция для вычисления дистанции между двумя точками на поверхности Земли
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Радиус Земли в км
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c * 1000;  // Расстояние в метрах
    }

</script>
</body>
</html>


-->


<!DOCTYPE html>
<html lang="en">
<head>
    <title>Krasnoyarsk Krai 3D Terrain with Model</title>
    <meta property="og:description" content="Go beyond hillshade and show elevation in actual 3D." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/three@0.152.0/build/three.min.js"></script>
    <script src="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/threebox-plugin@2.2.1/dist/threebox.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        #controls { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; z-index: 1; }
        .marker {
            background-color: red;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="controls">
    <h3>Введите координаты</h3>
    <input type="text" id="lat" placeholder="Широта">
    <input type="text" id="lng" placeholder="Долгота">
    <input type="text" id="alt" placeholder="Высота">
    <button id="addPoint">Добавить точку</button>
    <button id="drawPath">Построить путь</button>
    <button id="startFlight" style="display:none;">Начать полет</button>
</div>
<div id="map"></div>
<script type="module">
    const krasnoyarskBounds = [
        [90.0, 53.0], // Southwest coordinates [lng, lat]
        [96.0, 60.0]  // Northeast coordinates [lng, lat]
    ];

    const map = new maplibregl.Map({
        container: 'map',
        zoom: 6,
        center: [92.857, 56.015], // Center coordinates for Krasnoyarsk Krai
        pitch: 70,
        bearing: 0,
        antialias: true,
        style: {
            version: 8,
            sources: {
                osm: {
                    type: 'raster',
                    tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '&copy; OpenStreetMap Contributors',
                    maxzoom: 19
                },
                terrainSource: {
                    type: 'raster-dem',
                    tiles: [
                        'https://tiles.wifidb.net/data/jaxa_terrainrgb/{z}/{x}/{y}.png'
                    ],
                    tileSize: 256
                }
            },
            layers: [
                {
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }
            ],
            terrain: {
                source: 'terrainSource',
                exaggeration: 1.5
            },
            sky: {}
        },
        maxZoom: 18,
        maxPitch: 85,
        maxBounds: krasnoyarskBounds // Restrict map to Krasnoyarsk Krai
    });

    const tb = new Threebox(
        map,
        map.getCanvas().getContext('webgl'),
        {
            defaultLights: true
        }
    );
    window.tb = tb;
    const points = [];  // Массив для хранения точек маршрута
    let planeModel = null;
    let currentPointIndex = 0;  // Индекс текущей точки маршрута
    let totalDistance = 0;  // Общая дистанция маршрута

    map.on('style.load', () => {
        map.addLayer({
            id: 'custom_layer',
            type: 'custom',
            renderingMode: '3d',
            onAdd(map, mbxContext) {
                tb.update();
            },
            render(gl, matrix) {
                tb.update();
            }
        });
    });

    document.getElementById('addPoint').addEventListener('click', () => {
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(document.getElementById('lng').value);
        const alt = parseFloat(document.getElementById('alt').value);

        if (!isNaN(lat) && !isNaN(lng) && !isNaN(alt)) {
            points.push({ lat, lng, alt });
            alert(`Точка добавлена: [${lat}, ${lng}, ${alt}]`);

            const marker = new maplibregl.Marker()
                .setLngLat([lng, lat])
                .setPopup(new maplibregl.Popup().setText('Точка маршрута'))
                .addTo(map);
        } else {
            alert("Пожалуйста, введите валидные координаты.");
        }
    });

    // Функция для построения 3D линии
    function draw3dPath() {
        if (points.length < 2) {
            alert("Добавьте хотя бы две точки для построения пути.");
            return;
        }

        tb.world.clear();

        for (let i = 0; i < points.length - 1; i++) {
            const start = points[i];
            const end = points[i + 1];

            const line = tb.line({
                geometry: [
                    [start.lng, start.lat, start.alt],
                    [end.lng, end.lat, end.alt]
                ],
                color: '#dd0000',
                width: 4,
                opacity: 1
            });

            tb.add(line);
        }

        tb.update();
        alert("3D путь построен!");
        document.getElementById('startFlight').style.display = 'inline-block';
    }

    // Построение пути
    document.getElementById('drawPath').addEventListener('click', draw3dPath);

    // Начало полета
    document.getElementById('startFlight').addEventListener('click', () => {
        if (points.length < 2) {
            alert("Добавьте точки маршрута.");
            return;
        }

        // Загрузка модели самолета
        const options = {
            obj: 'http://localhost:9000/scene.glb', // Укажите путь к модели GLB
            type: 'gltf',
            scale: 0.3,
            units: 'meters',
            rotation: { x: 90, y: 0, z: 0 },
            anchor: 'center'
        };

        window.tb.loadObj(options, function (model) {
            planeModel = model;
            planeModel.setCoords([points[0].lng, points[0].lat, points[0].alt]);
            window.tb.add(planeModel);
            window.tb.update();

            // Расчет общей дистанции маршрута
            let totalDistance = 0;
            for (let i = 0; i < points.length - 1; i++) {
                totalDistance += calculateDistance(
                    points[i].lat, points[i].lng,
                    points[i + 1].lat, points[i + 1].lng
                );
            }

            // Переводим скорость из км/ч в м/с (1 км/ч = 1/3.6 м/с)
            const flightSpeed = 100 / 3.6;  // скорость в м/с

            // Начинаем анимацию
            let currentTime = 0;  // Текущее время анимации (в миллисекундах)
            const duration = totalDistance / flightSpeed * 1000; // Общая длительность полета в миллисекундах

            function animate() {
                currentTime += 1000 / 60; // Обновление каждую миллисекунду
                const t = currentTime / duration; // Прогресс (от 0 до 1)

                if (t < 1) {
                    // Находим две точки для интерполяции
                    const startIndex = Math.floor(t * (points.length - 1));
                    const endIndex = startIndex + 1;
                    const p1 = points[startIndex];
                    const p2 = points[endIndex];

                    // Интерполяция между точками маршрута
                    const interpolate = (p1, p2, t) => {
                        return {
                            lat: p1.lat + (p2.lat - p1.lat) * t,
                            lng: p1.lng + (p2.lng - p1.lng) * t,
                            alt: p1.alt + (p2.alt - p1.alt) * t,
                        };
                    };

                    const pos = interpolate(p1, p2, t);
                    planeModel.setCoords([pos.lng, pos.lat, pos.alt]);

                    // Вычисление угла для поворота самолета
                    const angle = calculateAngle(p1, p2);
                    planeModel.setRotation({ x: 0, y: angle * (180 / Math.PI), z: 0 });  // Поворот только по оси Y

                    window.tb.update();
                    requestAnimationFrame(animate); // Продолжаем анимацию
                } else {
                    alert("Полет завершен!");
                }
            }

            animate(); // Запуск анимации
        });
    });

    // Функция для вычисления дистанции между двумя точками на поверхности Земли
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Радиус Земли в км
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c * 1000;  // Расстояние в метрах
    }

    // Функция для вычисления угла между двумя точками
    function calculateAngle(p1, p2) {
        const dx = p2.lng - p1.lng;
        const dy = p2.lat - p1.lat;
        return Math.atan2(dy, dx);
    }

</script>
</body>
</html>

